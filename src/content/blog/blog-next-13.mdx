---
title: "ãƒ–ãƒ­ã‚°ã‚’Next.js 13ã«ç§»è¡Œã—ãŸ"
date: 2023-03-03
description: "React Server Component / App Routerã«å¯¾å¿œ"
tags: ["tech", "web", "nextjs", "react"]
emoji: "ğŸ“"
related: ["blog-renewal"]
---

ï¼ˆ2023/10/05 è¿½è¨˜ï¼‰Astroã§[æ›¸ãç›´ã—ãŸ](/blog/posts/blog-astro-renewal)

## ã¯ã˜ã‚ã«

:tada: Next.js 13.2ãŒãƒªãƒªãƒ¼ã‚¹ã•ã‚Œã€App Router (beta) & React Server Componentï¼ˆä»¥ä¸‹RSCï¼‰ãŒå®Ÿç”¨ã§ããã†ãªæ„Ÿã˜ã«ãªã£ã¦ããŸãŸã‚ã€ã“ã®ã‚µã‚¤ãƒˆã§ã‚‚ç§»è¡Œã—ãŸã€‚Metadata APIã€Route Handlerç­‰ã‚‚åŒæ™‚ã«å°å…¥ã—ãŸã€‚

## ã‚„ã£ãŸã“ã¨

ï¼ˆä¸€èˆ¬çš„ãªè¨­å®šã«ã¤ã„ã¦ã¯[ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://nextjs.org/docs/app)ç­‰ã‚’å‚ç…§ï¼‰

### next.config.js

```js title="next.config.mjs" {5-11}
/** @type {import('next').NextConfig} */
let nextConfig = {
  reactStrictMode: true,
  experimental: {
    serverComponentsExternalPackages: [
      "playwright",
      "svgo",
      "plaiceholder",
      "@plaiceholder/next",
      "fetch-site-metadata",
    ],
    scrollRestoration: true,
    appDir: true,
  },
  images: {
    formats: ["image/avif", "image/webp"],
    domains: ["asciinema.org", "raw.githubusercontent.com"],
  },
};
```

[`experimental.serverComponentsExternalPackages`](https://nextjs.org/docs/app/api-reference/next-config-js/serverExternalPackages)ã¨ã„ã†é …ç›®ãŒã‘ã£ã“ã†é‡è¦ã€‚Markdownã®å‡¦ç†ã«Node.jsã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹å ´åˆã€è©²å½“ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ã“ã“ã«åˆ—æŒ™ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã€‚

ã‚ã¨é–¢ä¿‚ãªã„ãŒ`next.config.js`ã¯ãƒ‰ã‚·ãƒ‰ã‚·ESMï¼ˆ`.mjs`ï¼‰ã§æ›¸ã“ã†ã€‚

### Markdown / MDXã®å‡¦ç†

[å…¬å¼ãƒ–ãƒ­ã‚°](https://nextjs.org/blog/next-13-2)ã‚’è¦‹ã‚‹é™ã‚Šã€`@next/mdx`ã€`next-mdx-remote`ã€`contentlayer`ã®ä¸‰è€…ã¯ç¾æ™‚ç‚¹ï¼ˆ2023/03/03ï¼‰ã§RSCã«å¯¾å¿œã—ã¦ã„ã‚‹ã€‚

[https://github.com/hashicorp/next-mdx-remote](https://github.com/hashicorp/next-mdx-remote)

[https://contentlayer.dev](https://contentlayer.dev)

`next-mdx-remote/rsc`ã‚’ä½¿ã£ãŸã¨ã“ã‚ã€å…¥å‡ºåŠ›ã®ä»•æ§˜ãŒå¾®å¦™ã«å¤‰æ›´ã•ã‚Œã¦ã„ã¦æˆ¸æƒ‘ã£ãŸã€‚`compileMDX`ã§JSXã‚’ç›´æ¥åã‹ã›ã‚‹ã‹ã€`<MDXRemote>`ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã«Markdown / MDXã‚’é£Ÿã‚ã›ã‚‹ã‹é¸ã¹ã‚‹ã‚ˆã†ã ï¼ˆãŠãã‚‰ãã©ã¡ã‚‰ã§ã‚‚å‡ºåŠ›ã«å·®ã¯ãªã„ï¼‰ã€‚

ãã®ã»ã‹ã€`frontmatter`ã«å‹ã‚’ä»˜ã‘ã‚‰ã‚Œã‚‹ã‚ˆã†ã«ãªã£ãŸã€‚

```ts title="lib/compiler.ts" {8-14}
import { compileMDX } from "next-mdx-remote/rsc";
...
import MDXComponent from "components/MDXComponent";
...
const compiler = async (source: string) => {
  const result: Promise<{
    content: JSX.Element;
    frontmatter: {
      slug: string;
      title: string;
      date: string;
      description: string;
      tags: string[];
    };
  }> = compileMDX({
    source,
    components: MDXComponent,
    options: {
      ...
    },
  });
  return result;
};

export default compiler;
```

### Route Handlerã«ã‚ˆã‚‹Open Graphï¼ˆOGï¼‰ç”»åƒç”Ÿæˆ

Next.js 13.2ã§å¾“æ¥ã®API Routesã‚’ä»£æ›¿ã™ã‚‹Route HandlerãŒç™»å ´ã—ãŸãŸã‚ã€ã¤ã„ã«[OG ç”»åƒç”Ÿæˆ](/blog/posts/blog-renewal#og-ç”»åƒã®ç”Ÿæˆ)ã§ä½¿ã£ã¦ã„ãŸ`pages`ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’å®Œå…¨ã«å»ƒæ­¢[^1]ã§ãã‚‹ã‚ˆã†ã«ãªã£ãŸã€‚

[^1]: å³å¯†ã«ã¯`404.js`ãŒã¾ã æ®‹ã£ã¦ã„ã‚‹ãŒã€ã“ã¡ã‚‰ã§æ›¸ã‹ãªãã¦ã‚‚å‡¦ç†ã•ã‚Œã‚‹ã®ã§`pages`ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªè‡ªä½“ã¯å‰Šé™¤å¯èƒ½

[https://nextjs.org/docs/app/building-your-application/routing/route-handlers](https://nextjs.org/docs/app/building-your-application/routing/route-handlers)

### Metadata API

åŒã˜ãNext.js 13.2ã§ç™»å ´ã€‚ã‚µã‚¤ãƒˆãƒãƒƒãƒ—ã®ç”Ÿæˆã«ä½¿ã£ãŸã€‚

```ts title="src/app/sitemap.ts"
import type { MetadataRoute } from "next";

import { globby } from "globby";

import { dateConverter } from "lib/build";
import { HOST } from "lib/constant";
// Article index file
import postIndex from "share/index.json";

import type { PostData } from "lib/interface";

export default async function sitemap(): Promise<MetadataRoute.Sitemap> {
  const constPaths = await globby(["src/app/**/page.tsx", "src/app/page.tsx"], {
    ignore: ["src/app/api/*.tsx", "src/app/grad_essay/**", "src/app/**/[*/**"],
  });

  const constPageEntries = constPaths.map((filePath) => {
    const constPageEntry = {
      relpath: filePath.replace("src/app/", "").replace("page.tsx", ""),
      lastmod: "",
    };
    return constPageEntry;
  });

  const blogposts = postIndex.articles.blog;

  const blogTags = postIndex.tags.blog;

  const blogEntries = blogposts.map((post: PostData) => {
    const blogEntry = {
      relpath: `blog/posts/${post.data?.slug}`,
      lastmod: dateConverter(post.data?.date),
    };
    return blogEntry;
  });

  const blogTagEntries = blogTags.map((tag: string) => {
    const blogTagEntry = {
      relpath: `blog/tag/${tag}`,
      lastmod: "",
    };
    return blogTagEntry;
  });

  const sitemapEntries = constPageEntries.concat(blogEntries, blogTagEntries);
  return sitemapEntries.map((entry) =>
    entry.lastmod !== ""
      ? {
          url: `https://${HOST}/${entry.relpath}`,
          lastModified: entry.lastmod,
        }
      : {
          url: `https://${HOST}/${entry.relpath}`,
        },
  );
}
```

## æ‰€æ„Ÿ

ã‚‚ã¨ã‚‚ã¨å®Œå…¨ãªé™çš„ã‚µã‚¤ãƒˆãªã®ã§ã€å®Ÿã®ã¨ã“ã‚ãã‚Œã»ã©ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã«å¤‰åŒ–ã¯ãªã„ã€‚ãƒãƒ³ãƒ‰ãƒ«ã‚µã‚¤ã‚ºã¯å¤šå°‘å°ã•ããªã£ãŸã‹ã‚‚ã—ã‚Œãªã„ãŒã€‚

![ãƒ“ãƒ«ãƒ‰çµæœ](../../assets/image/bundlesize_next13.png)

ã¡ãªã¿ã«Lighthouseã®ã‚¹ã‚³ã‚¢ã¯ã“ã‚“ãªæ„Ÿã˜ï¼š

![ãƒˆãƒƒãƒ—](../../assets/image/lighthouse_0.png)

![ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«](../../assets/image/lighthouse_1.png)

![ã“ã®è¨˜äº‹](../../assets/image/lighthouse_2.png)
