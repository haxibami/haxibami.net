---
slug: "blog-renewal"
title: "Next.jsã§ãƒ–ãƒ­ã‚°ã‚’ã¤ãã£ãŸ"
date: "20220326"
description: "è‡ªä½œãƒ–ãƒ­ã‚°ã®å®Ÿè£…ã«ã¤ã„ã¦"
tags: ["tech", "web", "nextjs"]
---

## ã¯ã˜ã‚ã«

<https://github.com/haxibami/haxibami.net>

ãƒ–ãƒ­ã‚°ã‚’è‡ªä½œã—ãŸã€‚æ±ºã‚æ‰‹ã¯ä»¥ä¸‹ã®å››ã¤ã€‚

1. é©åº¦ãªè·é›¢æ„Ÿ
1. ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹æ€§
1. é«˜é€Ÿæ€§ãƒ»æ‹¡å¼µæ€§
1. ç„¡åºƒå‘Š

### 1. é©åº¦ãªè·é›¢æ„Ÿ

ã‚ã‚‰ã‚†ã‚‹ã‚‚ã®ãŒæœ€é©åŒ–ã•ã‚Œã¦æä¾›ã•ã‚Œã‚‹ç’°å¢ƒã«ã‚ã£ã¦ã¯ã€é…é…ã‚„èª¤é…ã®ç¢ºç‡ã¯ååˆ†ã«ä½ããªã‚‹ã€‚å¤§ããªãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼ã® buzz ã‚’ã™ã™ã‚“ã§å¾ŒæŠ¼ã—ã—ã€ã‹ã‚Œã«å‘ã‘ã¦ã€ã‹ã‚Œã®ãŸã‚ã«ã€ã¨ãƒ‘ãƒ¼ã‚½ãƒŠãƒ©ã‚¤ã‚ºã«èºèµ·ã ã€‚æ›¸ãæ‰‹ã¨èª­ã¿æ‰‹ã®è·é›¢ã¯é€æ˜ã«ã€ã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã¯ç¢ºå®Ÿã«ã€‚ã ãŒãã†ã§ã¯ãªã„å½¢å¼ã‚‚ã‚ã£ãŸã€‚ã²ã‚‡ã£ã¨ã—ãŸã‚‰èª°ã‹ã«æ‹¾ã‚ã‚Œã‚‹ã‹ã‚‚ã—ã‚Œãªã„ã€ã‚ã‚‹ã„ã¯ã‚¯ãƒ­ãƒ¼ãƒ©ã«ã•ãˆæ‹¾ã‚ã‚Œãªã„ã‹ã‚‚ã—ã‚Œãªã„ã€ãã†ã—ãŸç¢ºç‡è«–çš„ãªé›²ã®ãªã‹ã«è‡ªã‚‰ã®æ›¸ã„ãŸã‚‚ã®ã‚’æ‰“ã¡ä¸Šã’ã‚‹ã€‚ãã—ã¦ç¥ˆã‚‹ã€‚{å¤ãè‰¯ãæ—¥ã€…}^(ã‚°ãƒƒãƒ‰ãƒ»ã‚ªãƒ¼ãƒ«ãƒ‰ãƒ»ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒ„)ã¯ç†æƒ³éƒ·ã§ã¯ãªã‹ã£ãŸã«ã—ã¦ã‚‚ã€ã‚ã®èª°ã‹ã®ã‚‚ã®ã«ãªã‚‹å‰ã®ä¸–ç•Œã®ã€ãã®æ­ªãªæ‰‹è§¦ã‚Šã‚’è¦šãˆã¦ãŠããŸã‚ã®ã€ã“ã®è·é›¢æ„Ÿã€‚

### 2. ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹æ€§

ã”å­˜çŸ¥ã®ã¨ãŠã‚Šã€ã“ã®æ‰‹ã®ã‚µã‚¤ãƒˆã¯ç®¡ç†ãƒ»ç§»è¡ŒãŒå„„åŠ«ã«ãªã£ãŸæ™‚ç‚¹ã§**ã‚¨ã‚¿ã‚‹**ã€‚æ”¾ç½®ã•ã‚ŒãŸã€Œã€‡ã€‡ã®éƒ¨å±‹ã€ã€æ¶ˆãˆã¦é‚„ã‚‰ãªã„å€Ÿã‚Šã‚‚ã®ã®ãƒ‰ãƒ¡ã‚¤ãƒ³ã€ã‚€ãªã—ãåˆ»ã‚€å…¥å®¤ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ãŸã¡ã‚’çœºã‚ã‚‹ãŸã³ã«ã€ã›ã‚ã¦è¨˜äº‹ãã‚‰ã„ã¯æ…£ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ã§æ¥½ã«æ‰±ã„ãŸã„ã¨æ€ã†ã‚ˆã†ã«ãªã£ãŸã€‚ãã†ã„ã†ã‚ã‘ã§ Markdownï¼ˆã‚³ãƒ³ãƒ†ãƒ³ãƒ„ï¼‰ + tsxï¼ˆãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆï¼‰ã€ã•ã‚‰ã« GitHub ãƒ‡ãƒ—ãƒ­ã‚¤ã§ã®è‡ªå‹•ãƒ“ãƒ«ãƒ‰ã€‚ã“ã®çµ„ã¿åˆã‚ã›ãªã‚‰ãã†ç°¡å˜ã«ã¯å»ƒã‚Œãªã„ã ã‚ã†ã—ã€ã„ã¤ã‹åˆ¥ã‚µãƒ¼ãƒ“ã‚¹ãƒ»åˆ¥ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã«ç§»ã‚‹ã¨ãã«ã‚‚ãã‚Œã»ã©å›°ã‚‰ãªã„ã€‚

ï¼ˆ2022/12/28 æ›´æ–°ï¼‰

Markdown ã®å‡¦ç†ç³»ã«ã¤ã„ã¦ã€‚ä»¥å‰ã¯`remark` + `rehype`ã®å‡ºåŠ›ã‚’`rehype-react` ã§ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã—ã¦ã„ãŸãŒã€`rehype-react`ï¼ˆå³å¯†ã«ã„ãˆã°ãã®ä¾å­˜å…ˆã®`parse5`ï¼‰ã®ãƒãƒ³ãƒ‰ãƒ«ã‚µã‚¤ã‚ºãŒãƒã‚«ã«ãªã‚‰ãªã„ã®ã§ã€`next-mdx-remote`ã«ä¹—ã‚Šæ›ãˆãŸã€‚

<https://github.com/hashicorp/next-mdx-remote>

ã“ã‚Œã¯ åå‰ã®é€šã‚Š MDX / Markdown ã‚’å‡¦ç†ã™ã‚‹ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ã§ã€å†…éƒ¨ã§ã¯`remark` / `rehype`ç³»ã® API ã‚’ç”¨ã„ã¦ã„ã‚‹ãŸã‚ã€ã»ã¼å¤‰æ›´ãªããƒ„ãƒ¼ãƒ«ãƒã‚§ã‚¤ãƒ³ã‚’æŒã¡è¾¼ã‚ã‚‹ã€‚ã¾ãŸãƒãƒ³ãƒ‰ãƒ«ã‚µã‚¤ã‚ºã®å‰Šæ¸›ã«ã‚‚æ³¨æ„ãŒæ‰•ã‚ã‚Œã¦ã„ã‚‹[ã‚‰ã—ã](https://github.com/hashicorp/next-mdx-remote#background--theory)ã€å®Ÿéš›ã«ç§ã®ç’°å¢ƒã§ã¯ `rehype-react`æ¯”ã§ 200KB ã»ã©ãƒãƒ³ãƒ‰ãƒ«ãŒå°ã•ããªã£ãŸã€‚

```ts title="lib/compile.ts"
import { serialize } from "next-mdx-remote/serialize";
import rehypeAutolinkHeadings from "rehype-autolink-headings";
import rehypeKatex from "rehype-katex";
import rehypePrettyCode from "rehype-pretty-code";
import rehypeRaw from "rehype-raw";
import rehypeSlug from "rehype-slug";
import remarkGemoji from "remark-gemoji";
import remarkGfm from "remark-gfm";
import remarkJaruby from "remark-jaruby";
import remarkMath from "remark-math";
import remarkUnwrapImages from "remark-unwrap-images";

import { remarkLinkWidget, extLinkHandler } from "lib/remark-link-card";
import remarkMermaid from "lib/remark-mermaid";

import type { Options } from "rehype-pretty-code";

export const compileMdx = async (file: string) => {
  const options: Partial<Options> = {
    theme: {
      dark: "rose-pine-moon",
    },
    onVisitLine(node) {
      if (node.children.length === 0) {
        node.children = [{ type: "text", value: " " }];
      }
    },
    onVisitHighlightedLine(node) {
      node.properties.className.push("highlighted");
    },
    onVisitHighlightedWord(node) {
      node.properties.className = ["word"];
    },
  };

  // compile md(x)
  const mdxSource = await serialize(file, {
    mdxOptions: {
      remarkPlugins: [
        remarkGfm,
        remarkGemoji,
        remarkMath,
        remarkJaruby,
        remarkLinkWidget,
        remarkUnwrapImages,
        [
          remarkMermaid,
          {
            launchOptions: {
              args: ["--no-sandbox", "--disable-setuid-sandbox"],
            },
            wrap: true,
            className: ["mermaid"],
          },
        ],
      ],
      rehypePlugins: [
        rehypeSlug,
        [rehypeAutolinkHeadings, { behavior: "wrap" }],
        rehypeKatex,
        [rehypePrettyCode, options],
        rehypeRaw,
      ],
      remarkRehypeOptions: {
        handlers: {
          extlink: extLinkHandler,
        },
      },
      format: "md",
      development: false,
    },
    parseFrontmatter: true,
  });

  return mdxSource;
};
```

![before](/image/bundlesize_pre.png)

![after](/image/bundlesize_post.png)

### 3. é«˜é€Ÿæ€§ãƒ»æ‹¡å¼µæ€§

å€‹äººã‚µã‚¤ãƒˆã« Next.js ã¯è‹¥å¹²ã‚ªãƒ¼ãƒãƒ¼ã‚­ãƒ«æ„Ÿã‚‚ã‚ã‚‹ãŒã€ã¾ã‚ãƒšãƒ¼ã‚¸é·ç§»ãŒæ°—æŒã¡ã„ã„ã—ã€Vercel ãªã‚‰ç”»åƒæœ€é©åŒ–åŠ¹ãã—â€¦â€¦ã“ã†ã—ã¦ãƒ™ãƒ³ãƒ€ãƒ¼ãƒ­ãƒƒã‚¯ã‚¤ãƒ³ã¸ã¨çªãé€²ã‚“ã§ã‚†ãã®ã§ã—ãŸã€‚ã‚ã¨å°‘ã€…è¤‡é›‘ãªã“ã¨ã‚’ã—ã‚ˆã†ã¨ã—ã¦ã‚‚ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã®å®ˆå‚™ç¯„å›²ã‚’ã¯ã¿å‡ºã•ãªã„ã¨ã„ã†ã®ã¯è‰¯ã„ã€‚

### 4. åºƒå‘Šã‚„çµ±è¨ˆã®æ’é™¤

éå‰°ãªåºƒå‘Šãƒ»çµ±è¨ˆã«å¯¾ã—ã¦æ†æ‚ªã‚’æŠ±ã„ã¦ã„ã‚‹ãŸã‚ã€ã“ã®ã‚µã‚¤ãƒˆã«ã¯ä¸€åˆ‡è¨­ç½®ã—ã¦ã„ãªã„ã€‚å”¯ä¸€ã€ã“ã®ã‚µã‚¤ãƒˆã®ãƒ›ã‚¹ãƒˆå…ˆã§ã‚ã‚‹ Vercel ãŒè¡Œã£ã¦ã„ã‚‹ã‚¢ãƒŠãƒªãƒ†ã‚£ã‚¯ã‚¹ã ã‘ã¯ç¢ºèªã—ã¦ã„ã‚‹ã€‚[ã“ã¡ã‚‰ã®è¨˜äº‹](/blog/posts/nextdns-install)ã‚‚å‚ç…§ã€‚

## å±•ç¤ºä¼š

ä»¥ä¸‹ã¯ã“ã®ãƒ–ãƒ­ã‚°ã®æ©Ÿèƒ½ãƒ»å®Ÿè£…ã®å±•ç¤ºä¼šã€‚

### è¨˜äº‹ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã®å–ã‚Šæ‰±ã„

`remark-frontmatter`ã¨`vfile-matter`ã§ frontmatter ã‹ã‚‰è¨˜äº‹ã®ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã€‚ã¾ãŸ`strip-markdown`ã§æœ¬æ–‡ä¸­ã®ä½™åˆ†ãªè¦ç´ ã‚’é™¤å»ã—ã€å†’é ­ 300 å­—ç¨‹åº¦ã‚’æŠ½å‡ºã—ãŸã‚‚ã®ã‚’å„è¨˜äº‹ã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã¨ã—ã¦è¡¨ç¤ºã—ã¦ã„ã‚‹ã€‚

<https://github.com/remarkjs/remark-frontmatter>

<https://github.com/vfile/vfile-matter>

<https://github.com/remarkjs/strip-markdown>

```md
---
slug: "blog-renewal"
title: "Next.jsã§ãƒ–ãƒ­ã‚°ã‚’ã¤ãã£ãŸ"
date: "20220326"
tags: ["tech", "web", "nextjs"]
---
```

```ts title="lib/parser.ts"
// Markdown parser for metadata & preview data

import remarkFrontmatter from "remark-frontmatter";
import remarkParse from "remark-parse";
import remarkStringify from "remark-stringify";
import stripMarkdown from "strip-markdown";
import { unified } from "unified";
import { matter } from "vfile-matter";

import type { VFile } from "vfile-matter";

declare module "vfile" {
  interface DataMap {
    matter: {
      slug: string;
      title: string;
      date?: string;
      description: string;
      tags?: string[];
    };
  }
}

/**
 * Plugin to parse YAML frontmatter and expose it at `file.data.matter`.
 *
 * @type {import('unified').Plugin<Array<void>>}
 */
export default function remarkParseMatter() {
  return function (_: void, file: VFile) {
    matter(file);
  };
}

export const mdInfo = async (md: string) => {
  const result = await unified()
    .use(remarkParse)
    .use(stripMarkdown, {
      remove: ["heading", "list", "blockquote", "code", "image"],
    })
    .use(remarkStringify)
    .use(remarkFrontmatter)
    .use(remarkParseMatter)
    .process(md);

  return {
    preview: result.toString().substring(0, 300),
    data: result.data.matter,
  };
};
```

### GitHub Flavored Markdown

<https://github.com/remarkjs/remark-gfm>

```md
| è¡¨ã‚’     | ä½œã‚‹       |
| -------- | ---------- |
| ãŸã¨ãˆã° | ã“ã®ã‚ˆã†ã« |
| è¦ç´ ã‚’   | å¢—ã‚„ã™     |

<https://www.haxibami.net>

ã¿ãŸã„ãªç”Ÿã®ãƒªãƒ³ã‚¯ã‚‚ç½®ã‘ã‚‹ã—

- ã“ã†ã‚„ã£ã¦
  - ãƒªã‚¹ãƒˆãŒæ›¸ã‘ã‚‹ã€‚ã•ã‚‰ã«ã€[^1]

[^1]: è„šæ³¨ã‚‚ä½¿ãˆã‚‹
```

| è¡¨ã‚’     | ä½œã‚‹       |
| -------- | ---------- |
| ãŸã¨ãˆã° | ã“ã®ã‚ˆã†ã« |
| è¦ç´ ã‚’   | å¢—ã‚„ã™     |

<https://www.haxibami.net>

ã¿ãŸã„ãªç”Ÿã®ãƒªãƒ³ã‚¯ã‚‚ç½®ã‘ã‚‹ã—

- ã“ã†ã‚„ã£ã¦
  - ãƒªã‚¹ãƒˆãŒæ›¸ã‘ã‚‹ã€‚ã•ã‚‰ã«ã€[^1]

[^1]: è„šæ³¨ã‚‚ä½¿ãˆã‚‹

### çµµæ–‡å­—

<https://github.com/remarkjs/remark-gemoji>

`:v:`ãŒ :v: ã«ã€‚

### æ•°å¼

<https://github.com/remarkjs/remark-math>

<https://github.com/remarkjs/remark-math/tree/main/packages/rehype-katex>

ãƒ•ã‚©ãƒ³ãƒˆã®è¨­ç½®ã¯å¿…è¦ãªã„ãŒã€KaTeX ã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚·ãƒ¼ãƒˆã‚’ç½®ã„ã¦ãŠãå¿…è¦ãŒã‚ã‚‹ã€‚

```tsx title="pages/blog/posts/[slug].tsx"
const Blog: NextPage<Props> = ({ pageMetaData, post, content }) => {
  return (
    <div id={Styles.Wrapper}>
      <div id={Styles.Container}>
        <MyHead {...pageMetaData} />
        <Head>
          <link
            rel="stylesheet"
            href="https://cdn.jsdelivr.net/npm/katex@0.15.3/dist/katex.min.css"
            integrity="sha384-KiWOvVjnN8qwAZbuQyWDIbfCLFhLXNETzBQjA/92pIowpC0d2O3nppDGQVgwd2nB"
            crossOrigin="anonymous"
          />
        </Head>
// (ç•¥)
```

```md
> $$
> ( \sum_{k=1}^{n} a_k b_k )^2 \leq ( \sum_{k=1}^{n} {a_k}^2 ) ( \sum_{k=1}^{n} {b_k}^2 )
> $$
```

> $$
> ( \sum_{k=1}^{n} a_k b_k )^2 \leq ( \sum_{k=1}^{n} {a_k}^2 ) ( \sum_{k=1}^{n} {b_k}^2 )
> $$

$e^{i\pi} + 1 = 0$ :arrow_left: ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³æ•°å¼

### ãƒ«ãƒ“

`remark-ruby`ã¨ã„ã†ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ãƒ•ã‚©ãƒ¼ã‚¯ã™ã‚‹å½¢ã§ã€åˆ¥ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ï¼ˆ`remark-jaruby`ï¼‰ã‚’å®Ÿè£…ã€‚

<https://github.com/haxibami/remark-jaruby>

```md
> æ˜¨æ—¥åˆå¾Œã€{â€ è–å‰£â€ }^(ã‚¨ã‚¯ã‚¹ã‚«ãƒªãƒãƒ¼)ã‚’æŒ¯ã‚Šå›ã™{å…¨è£¸ä¸­å¹´ç”·æ€§}^(ç„¡æ•µã®äºº)ãŒå‡ºç¾ã—â€¦â€¦
```

> æ˜¨æ—¥åˆå¾Œã€{â€ è–å‰£â€ }^(ã‚¨ã‚¯ã‚¹ã‚«ãƒªãƒãƒ¼)ã‚’æŒ¯ã‚Šå›ã™{å…¨è£¸ä¸­å¹´ç”·æ€§}^(ç„¡æ•µã®äºº)ãŒå‡ºç¾ã—â€¦â€¦

### ãƒšãƒ¼ã‚¸å†…ãƒªãƒ³ã‚¯

<https://github.com/rehypejs/rehype-slug>

<https://github.com/rehypejs/rehype-autolink-headings>

[ã¯ã˜ã‚ã«](#ã¯ã˜ã‚ã«)ã«é£›ã¹ã‚‹ã‚ˆ

### Mermaid Diagram

[remark-mermaidjs](https://github.com/remcohaszing/remark-mermaidjs)ã‚’ãƒ™ãƒ¼ã‚¹ã« remark ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚’æ›¸ã„ãŸã€‚è£ã§ãƒ˜ãƒƒãƒ‰ãƒ¬ã‚¹ Chromium ã‚’ç«‹ã¡ä¸Šã’ã¦ SVG ã‚’æç”»ã€å‡ºåŠ›ã—ã¦ã„ã‚‹ã€‚ã‚µã‚¤ãƒˆå†…ã« JS ã‚’è¨­ç½®ã—ã¦ãƒ¦ãƒ¼ã‚¶ãƒ¼å´ã§å‹•çš„ã«ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã•ã›ã‚‹ã“ã¨ã‚‚ã§ãã‚‹ãŒã€äº‹å‰ã«é™çš„ãª SVG ã«å¤‰æ›ã§ããŸã»ã†ãŒå¬‰ã—ã„ã€‚

```ts title="lib/remark-mermaid.ts"
...

const remarkMermaid: Plugin<[RemarkMermaidOptions?]> = function mermaidTrans(
  options
): Transformer {
  const DEFAULT_SETTINGS = {
    launchOptions: {
      args: ["--no-sandbox", "--disable-setuid-sandbox"],
    },
    theme: "default",
    wrap: false,
    classname: [],
  };

  const settings = Object.assign({}, DEFAULT_SETTINGS, options);

  // eslint-disable-next-line @typescript-eslint/no-unused-vars
  return async (node: Node, _file: VFileCompatible) => {
    const promises: (() => Promise<void>)[] = [];
    const browser = await playwright.chromium.launch(settings.launchOptions);
    const context = await browser.newContext({
      viewport: { width: 1000, height: 3000 },
    });
    const page = await context.newPage();
    const html = `<!DOCTYPE html>`;
    await page.setContent(html);
    await page.addScriptTag({
      url: "https://unpkg.com/mermaid/dist/mermaid.min.js",
      type: "module",
    });
    await page.setViewportSize({ width: 1000, height: 3000 });
    visit(node, isMermaid, visitor);
    await Promise.all(promises.map((t) => t()));
    await browser.close();

    function visitor(node: Code, index: number, parent: Parent | undefined) {
      if (!isParent(parent)) {
        return;
      }
      promises.push(async () => {
        const svg = await getSvg(node, page, settings.theme);
        if (settings.wrap) {
          parent.children[index] = {
            type: "parent",
            children: [],
            data: {
              hChildren: [
                {
                  type: "element",
                  children: [svgParse(svg)],
                  tagName: "div",
                  properties: {
                    className: settings.classname,
                  },
                },
              ],
            },
          } as Parent;
        } else {
          parent.children[index] = {
            type: "paragraph",
            children: [],
            data: {
              hChildren: [svgParse(svg)],
            },
          } as Paragraph;
        }
      });
      return true;
    }
  };
};

async function getSvg(node: Code, page: playwright.Page, theme: Theme) {
  const graph = await page.evaluate(
    ([code, theme]) => {
      const id = "a";
      const config: MermaidConfig = {
        theme: theme as Theme,
        startOnLoad: false,
      };
      mermaid.mermaidAPI.initialize(config);
      const div = document.createElement("div");
      mermaid.mermaidAPI.render(id, code, (svg: string) => {
        div.innerHTML = svg;
      });
      return div.innerHTML;
    },
    [node.value, theme]
  );

  ...
}
```

````md
```mermaid
sequenceDiagram
Alice->>John: Hello John, how are you?
loop Healthcheck
    John->>John: Fight against hypochondria
end
Note right of John: Rational thoughts!
John-->>Alice: Great!
John->>Bob: How about you?
Bob-->>John: Jolly good!
```

```mermaid
pie
"Dogs" : 386
"Cats" : 85
"Rats" : 15
```
````

```mermaid
sequenceDiagram
Alice->>John: Hello John, how are you?
loop Healthcheck
    John->>John: Fight against hypochondria
end
Note right of John: Rational thoughts!
John-->>Alice: Great!
John->>Bob: How about you?
Bob-->>John: Jolly good!
```

```mermaid
pie
"Dogs" : 386
"Cats" : 85
"Rats" : 15
```

### ã‚·ãƒ³ã‚¿ãƒƒã‚¯ã‚¹ãƒã‚¤ãƒ©ã‚¤ãƒˆ

`rehype-pretty-code`ã‚’æ¡ç”¨ã€‚ã“ã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã¯å†…éƒ¨ã§[shiki](https://shiki.matsu.io)ã‚’åˆ©ç”¨ã—ã¦ãŠã‚Šã€ãƒ•ã‚¡ã‚¤ãƒ«åã‚„è¡Œæ•°ã®è¡¨ç¤ºã€è¡Œãƒã‚¤ãƒ©ã‚¤ãƒˆãªã©ã®æ©Ÿèƒ½ã‚’è¿½åŠ ã—ãŸå®Ÿè³ªçš„ãªãƒ©ãƒƒãƒ‘ãƒ¼ã«ãªã£ã¦ã„ã‚‹ã€‚shiki ã¯ã‚³ãƒ¼ãƒ‰è§£æãƒ»ã‚¹ã‚¿ã‚¤ãƒ«é©ç”¨ãŒãƒ“ãƒ«ãƒ‰æ™‚ã«ã™ã¹ã¦æ¸ˆã‚€ï¼ˆå‡ºåŠ›ãŒé™çš„ï¼‰ã€VSCode ã®ã‚«ãƒ©ãƒ¼ã‚¹ã‚­ãƒ¼ãƒ ãƒ•ã‚¡ã‚¤ãƒ«ãŒä½¿ãˆã‚‹ã€ãªã©ã®å¼·ã¿ãŒã‚ã‚‹ã€‚

<https://github.com/atomiks/rehype-pretty-code>

<https://github.com/shikijs/shiki>

### ãƒªãƒ³ã‚¯ã‚«ãƒ¼ãƒ‰

<https://zenn.dev/tomi/articles/2021-03-22-blog-card>

<https://zenn.dev/januswel/articles/745787422d425b01e0c1>

:point_up_2: ã‚’å‚è€ƒã«ã—ã¤ã¤ã€unified ã® Transformer ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã¨ã—ã¦å®Ÿè£…ã—ãŸã€‚æ–‡æ›¸ä¸­ã®ãƒªãƒ³ã‚¯ï¼ˆ`Paragraph`ãƒãƒ¼ãƒ‰ã‹ã¤ã€å­è¦ç´ ãŒå˜ä¸€ã®`Link`ãƒãƒ¼ãƒ‰ã§ã‚ã‚‹ã‚‚ã®ï¼‰ã‚’å–å¾—ã—ã€é©å½“ãªç‹¬è‡ªãƒãƒ¼ãƒ‰ï¼ˆ`<extlink>`ï¼‰ã«ç½®ãæ›ãˆãŸã®ã¡ã€ãƒªãƒ³ã‚¯å…ˆã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦å¾—ãŸãƒ¡ã‚¿æƒ…å ±ï¼ˆtitleã€descriptionã€OGP ç”»åƒ URL ç­‰ï¼‰ã‚’æŒãŸã›ã¦ã„ã‚‹ã€‚ã“ã‚Œã‚’`<MDXRemote>`ã®`components`ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ä½¿ã£ã¦ã‚«ã‚¹ã‚¿ãƒ ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã«å¤‰æ›ã™ã‚‹ã“ã¨ã§ã€å¥½ããªã‚¹ã‚¿ã‚¤ãƒ«ã§ãƒªãƒ³ã‚¯ã‚«ãƒ¼ãƒ‰ãŒè¡¨ç¤ºã§ãã‚‹ã€‚

```ts title="lib/remark-link-card.ts"
import getMetadata from "metadata-scraper";
import { visit } from "unist-util-visit";

import { isParent, isLink, isParagraph } from "./mdast-util-node-is";

import type { Paragraph, Link, Literal } from "mdast";
import type { H } from "mdast-util-to-hast";
import type { Plugin, Transformer } from "unified";
import type { Node, Parent } from "unist";
import type { VFileCompatible } from "vfile";

interface ExtLink extends Literal {
  type: "extlink";
  meta: LinkWidgetMeta;
}

interface LinkWidgetMeta {
  url: string;
  title: string;
  description: string;
  og: string;
  icon: string;
}

function isExtLink(node: unknown): node is Paragraph {
  if (!isParagraph(node)) {
    return false;
  }

  const { children } = node;

  if (children.length != 1) {
    return false;
  }

  const singleChild = children[0];
  if (!(isLink(singleChild) && singleChild.children[0].type == "text")) {
    return false;
  }

  return true;
}

function fetchMeta(url: string) {
  const metas = getMetadata(url).then((data) => {
    const metaData: LinkWidgetMeta = {
      url: url,
      title: data.title ?? "",
      description: data.description ?? "",
      og: data.image ?? "",
      icon: data.icon ?? "",
    };
    return metaData;
  });
  return metas;
}

export const remarkLinkWidget: Plugin = function extLinkTrans(): Transformer {
  // eslint-disable-next-line @typescript-eslint/no-unused-vars
  return async (tree: Node, _file: VFileCompatible) => {
    const promises: (() => Promise<void>)[] = [];
    visit(tree, isExtLink, visitor);
    await Promise.all(promises.map((t) => t()));

    function visitor(
      node: Paragraph,
      index: number,
      parent: Parent | undefined
    ) {
      if (!isParent(parent)) {
        return;
      }

      if (parent.type === "listItem") {
        return;
      }

      const child = node.children[0] as Link;

      promises.push(async () => {
        const data = await fetchMeta(child.url);
        parent.children[index] = {
          type: "extlink",
          meta: data,
        } as ExtLink;
      });
    }
  };
};

export function extLinkHandler(_h: H, node: ExtLink) {
  return {
    type: "element" as const,
    tagName: "extlink",
    properties: {
      url: node.meta.url,
      title: node.meta.title,
      description: node.meta.description,
      og: node.meta.og,
      icon: node.meta.icon,
    },
    children: [],
  };
}
```

ãªãŠã€å†…éƒ¨ã§`fetch`ã‚’è¡Œã£ã¦ã„ã‚‹éƒ½åˆä¸Šã€ä½œæˆã—ãŸãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã¯éåŒæœŸãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã¨ãªã‚‹ã“ã¨ã«ç•™æ„ã€‚å…·ä½“çš„ã«ã¯ unified ã§`processSync`ãŒ[ä½¿ãˆãªããªã‚‹](https://github.com/unifiedjs/unified#processorprocesssyncfile)ã€‚

### ç”»åƒã¨ãƒªãƒ³ã‚¯ã®å‡¦ç†

Markdown ã§æŒ¿å…¥ã—ãŸç”»åƒã¯ãã®ã¾ã¾ã§ã¯é€šå¸¸ã®`<img>`ã‚¿ã‚°ã«å¤‰æ›ã•ã‚Œã‚‹ãŸã‚ã€Next.js ã®ç”»åƒæœ€é©åŒ–ã®å¯¾è±¡ã«ã¯ãªã‚‰ãªã„ã€‚ãŒã€ã“ã‚Œã‚‚`<MDXRemote>`ã®`components`ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã§ç‹¬è‡ªã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã«ç½®æ›ã™ã‚‹ã“ã¨ã§è§£æ±ºã§ãã‚‹ã€‚ä»¥ä¸‹ã®ä¾‹ã§ã¯ç”»åƒã«ãƒªãƒ³ã‚¯ã‚’ä»˜åŠ ã—ã€`alt`ãƒ†ã‚­ã‚¹ãƒˆã‚’ã‚­ãƒ£ãƒ—ã‚·ãƒ§ãƒ³ã¨ã—ã¦è¿½è¨˜ã—ã¦ã„ã‚‹ã€‚åŒæ§˜ã®ã“ã¨ãŒãƒªãƒ³ã‚¯ï¼ˆ`<a>`ã‚¿ã‚° â†’`<Link>`ï¼‰ã«ã¤ã„ã¦ã‚‚å¯èƒ½ã€‚

```tsx title="components/NextImage.tsx"
import React from "react";

import Image from "next/image";
import Link from "next/link";

import Styles from "./style.module.scss";

export type NextImageProps = {
  src: string;
  alt?: string;
};

const NextImage: React.FC<NextImageProps> = (props) => {
  const { src, alt } = props;
  return alt !== "asciicast" ? (
    <figure className={Styles.Figure}>
      <Link href={src} scroll={false}>
        <div className={Styles.ImgBox}>
          <Image
            className={Styles.Img}
            src={src}
            alt={alt || src}
            fill={true}
          />
        </div>
      </Link>
      <figcaption>{alt}</figcaption>
    </figure>
  ) : (
    <div className={Styles.ImgBox}>
      <Image className={Styles.Img} src={src} alt={alt} fill={true} />
    </div>
  );
};

export default NextImage;
```

### ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰

å¤–éƒ¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ä½¿ç”¨ã€‚

<https://github.com/pacocoursey/next-themes>

### å‹•çš„ OGP ç”»åƒã®è‡ªå‹•ç”Ÿæˆ

ï¼ˆ2022/12/28 æ›´æ–°ï¼‰

ä»¥å‰ã®ãƒ˜ãƒƒãƒ‰ãƒ¬ã‚¹ Chromium ã‚’ä½¿ã£ãŸå®Ÿè£…ã‹ã‚‰ã€Vercel å…¬å¼ãŒæä¾›ã™ã‚‹[æ–°ã—ã„ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ](https://vercel.com/docs/concepts/functions/edge-functions/og-image-generation)ï¼ˆ`@vercel/og`ï¼‰ã«ä¹—ã‚Šæ›ãˆãŸã€‚[yoga-layout](https://yogalayout.com/)ã‹ãªã«ã‹ã®ã‚¹ã‚¿ã‚¤ãƒªãƒ³ã‚°ã‚¨ãƒ³ã‚¸ãƒ³ã‚’ WASM ã§å‹•ã‹ã—ã¦ã„ã‚‹ã‚‰ã—ãã€ã‹ãªã‚Šé€Ÿã„ã€‚ã—ã‹ã‚‚ Tailwind ãŒä½¿ãˆã‚‹ï¼ˆãŸã ã—ä½¿ãˆã‚‹ CSS ãƒ«ãƒ¼ãƒ«ã¯é™å®šçš„ï¼‰ã€‚

```tsx title="pages/api/ogp.tsx"
import type { NextRequest } from "next/server";

import { ImageResponse } from "@vercel/og";

export const config = {
  runtime: "experimental-edge",
};

const handler = async (req: NextRequest) => {
  try {
    const { searchParams } = new URL(req.url);
    const title = searchParams.has("title")
      ? searchParams.get("title")?.slice(0, 80)
      : "";
    const date = searchParams.has("date")
      ? `ğŸ“… â€• ${searchParams.get("date")?.slice(0, 8)}`
      : "";

    // CJK font is so large that if placed locally it easily exceeds the 1MB Edge Function limit >_<
    const notoFontData = await fetch(
      "https://rawcdn.githack.com/haxibami/Noto-Sans-CJK-JP/master/fonts/NotoSansCJKjp-Bold.woff"
    ).then((res) => res.arrayBuffer());

    const robotoFontData = await fetch(
      new URL("../../assets/RobotoMono-Medium.woff", import.meta.url)
    ).then((res) => res.arrayBuffer());

    const pngIcon = new URL(
      "../../assets/icon_ange_glasses_192.png",
      import.meta.url
    ).toString();

    return new ImageResponse(
      (
        <div
          style={{
            height: "100%",
            width: "100%",
            display: "flex",
            flexDirection: "column",
            alignItems: "center",
            justifyContent: "center",
            padding: "30px",
            fontFamily: "Noto Sans CJK JP",
            backgroundColor: "#171726",
            color: "#f2f0e6",
          }}
        >
          <div tw="flex flex-col p-12 w-full h-full border-solid border-4 border-white rounded-xl">
            <div tw="flex flex-1 max-w-full items-center max-h-full">
              <h1 tw="text-6xl leading-tight max-w-full">
                <p tw="w-full justify-center">{title}</p>
              </h1>
            </div>
            <div tw="flex flex-row justify-between items-center w-full">
              <div tw="flex items-center">
                {/* eslint-disable-next-line @next/next/no-img-element */}
                <img
                  src={pngIcon}
                  alt="haxicon"
                  width={100}
                  height={100}
                  tw="rounded-full mr-5"
                />
                <h2 tw="text-4xl mr-5">
                  <p
                    style={{
                      fontFamily: "Roboto Mono",
                    }}
                  >
                    haxibami.net
                  </p>
                </h2>
              </div>
              <div tw="flex">
                <h2 tw="text-4xl">
                  <p>{date}</p>
                </h2>
              </div>
            </div>
          </div>
        </div>
      ),
      {
        fonts: [
          {
            name: "Noto Sans CJK JP",
            data: notoFontData,
            weight: 700,
            style: "normal",
          },
          {
            name: "Roboto Mono",
            data: robotoFontData,
            weight: 500,
            style: "normal",
          },
        ],
      }
    );
  } catch (e) {
    console.log(`${e}`);
    return new Response(`Failed to generate the image`, {
      status: 500,
    });
  }
};

export default handler;
```

ãªãŠã€ã“ã®é–¢æ•°ã¯ Edge ç’°å¢ƒã§å®Ÿè¡Œã•ã‚Œã‚‹ãŸã‚ã€ç·å®¹é‡åˆ¶é™ã¯**1MB**ã¨ã‹ãªã‚Šå³ã—ã„ã€‚æ—¥æœ¬èªãƒ•ã‚©ãƒ³ãƒˆã¯å†…è”µã®ã‚‚ã®ï¼ˆNoto Sans JPï¼Ÿï¼‰ã§å¦¥å”ã™ã‚‹ã‹ã€ã‚µãƒ–ã‚»ãƒƒãƒˆåŒ–ã—ãŸã‚‚ã®ã‚’ Web ãƒ•ã‚©ãƒ³ãƒˆã¨ã—ã¦ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã—ã‹ãªã„ã€‚

### ã‚µã‚¤ãƒˆãƒãƒƒãƒ—ç”Ÿæˆ

frontmatter ã«è¨˜è¼‰ã—ãŸæƒ…å ±ã«åˆã‚ã›ã¦ã‚µã‚¤ãƒˆãƒãƒƒãƒ—ã‚’ç”Ÿæˆã—ãŸã‹ã£ãŸã®ã§ã€[ã“ã®ã¸ã‚“](https://www.mk-engineer.com/posts/nextjs-before-build)ã‚’å‚è€ƒã«ã—ã¤ã¤è‡ªåˆ†ã§æ›¸ã„ãŸã€‚npm scripts ã‚’æ´»ç”¨ã—ã€

1. ãƒ“ãƒ«ãƒ‰å‰ã«è¨˜äº‹ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥
1. ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã«åŸºã¥ã„ã¦`public/sitemap.xml`ã¨`public/robots.txt`ã‚’ç”Ÿæˆ

ã™ã‚‹ã‚ˆã†ã«ã—ã¦ã‚ã‚‹ã€‚

```js title="hooks/scripts/sitemap.mts"
import fs from "fs";

import { globby } from "globby";
import prettier from "prettier";

import { dateConverter } from "./lib/build.js";
import { HOST } from "./lib/constant.js";

import type { PostData } from "./lib/interface.js";

// variables
const XMLFILE = "sitemap.xml";

// Article index file
const postIndexFile = fs.readFileSync("src/share/index.json", "utf-8");
const postIndex = JSON.parse(postIndexFile);

// format xml
const formatXml = (sitemap: string) =>
  prettier.format(sitemap, { parser: "html" });

// generate sitemap & robots.txt
const sitemapGenerator = async () => {
  const solidPaths = await globby(["src/pages/*.tsx", "src/pages/blog/*.tsx"], {
    ignore: [
      "src/pages/_*.tsx",
      "src/pages/404.tsx",
      "src/pages/grad_essay.tsx",
    ],
  });

  const solidPageInfos = solidPaths.map((filePath) => {
    const solidPageInfo = {
      relpath: filePath
        .replace("src/pages/", "")
        .replace(".tsx", "")
        .replace("index", ""),
      lastmod: new Date().toISOString(),
    };
    return solidPageInfo;
  });

  const blogposts = postIndex.articles.blog;

  const blogInfos = blogposts.map((post: PostData) => {
    const blogInfo = {
      relpath: `blog/posts/${post.data?.slug}`,
      lastmod: dateConverter(post.data?.date),
    };
    return blogInfo;
  });

  const sitemapInfos = solidPageInfos.concat(blogInfos);

  const pagesSitemap = `

  ${sitemapInfos
    .map((info) => {
      return `
        <url>
          <loc>https://${HOST}/${info.relpath}</loc>
          <lastmod>${info.lastmod}</lastmod>
        </url>
      `;
    })
    .join("")}
  `;

  const generatedSitemap = `
<?xml version="1.0" encoding="UTF-8"?>
<urlset
  xmlns="http://www.sitemaps.org/schemas/sitemap/0.9"
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xsi:schemaLocation="http://www.sitemaps.org/schemas/sitemap/0.9 http://www.sitemaps.org/schemas/sitemap/0.9/sitemap.xsd"
>
  ${pagesSitemap}
</urlset>
  `;

  const robots = `# *
User-agent: *
Allow: /

# Host
Host: https://www.haxibami.net

# Sitemaps
Sitemap: https://www.haxibami.net/sitemap.xml
`;

  fs.writeFileSync(`public/${XMLFILE}`, formatXml(generatedSitemap));
  fs.writeFileSync("public/robots.txt", robots);
};

const genSitemap = () => {
  return new Promise<void>((resolve) => {
    sitemapGenerator();
    resolve();
  });
};

export default genSitemap;
```

### ãƒ•ã‚£ãƒ¼ãƒ‰å¯¾å¿œ

`Feed`ã¨ã„ã†ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ä½¿ã£ãŸã€‚ä¸Šã¨åŒã˜è¦é ˜ã§ã€ãƒ“ãƒ«ãƒ‰æ™‚ã«`/public/rss`ä»¥ä¸‹ã« RSSã€Atomã€JSON Feed ç”¨ã®ãƒ•ã‚¡ã‚¤ãƒ«ä¸‰ç¨®ã‚’åã‹ã›ã¦ã„ã‚‹ã€‚

<https://github.com/jpmonette/feed>

```js title="hooks/scripts/feed.mts"
import fs from "fs";

import { Feed } from "feed";

import { dateConverter } from "./lib/build.js";
import { SITEDATA } from "./lib/constant.js";
import { getPostsData } from "./lib/fs.js";

// variables
const HOST = "https://www.haxibami.net";

// generate feed
const feedGenerator = async () => {
  const author = {
    name: "haxibami",
    email: "contact@haxibami.net",
    link: HOST,
  };

  const date = new Date();
  const feed = new Feed({
    title: SITEDATA.blog.title,
    description: SITEDATA.blog.description,
    id: HOST,
    link: HOST,
    language: "ja",
    image: `${HOST}/icon_ange_glasses_192.png`,
    favicon: `${HOST}/favicon.ico`,
    copyright: `All rights reserved ${date.getFullYear()}, ${author.name}`,
    updated: date,
    feedLinks: {
      rss2: `${HOST}/rss/feed.xml`,
      json: `${HOST}/rss/feed.json`,
      atom: `${HOST}/rss/atom.xml`,
    },
    author: author,
  });

  const blogs = await getPostsData("articles/blog");

  blogs.forEach((post) => {
    const url = `${HOST}/blog/posts/${post.data?.slug}`;
    feed.addItem({
      title: `${post.data?.title}`,
      description: `${post.preview}`,
      id: url,
      link: url,
      date: new Date(dateConverter(post.data?.date)),
    });
  });

  fs.mkdirSync("public/rss", { recursive: true });
  await Promise.all([
    fs.promises.writeFile("public/rss/feed.xml", feed.rss2()),
    fs.promises.writeFile("public/rss/atom.xml", feed.atom1()),
    fs.promises.writeFile("public/rss/feed.json", feed.json1()),
  ]);
};

const GenFeed = () => {
  return new Promise<void>((resolve) => {
    feedGenerator();
    resolve();
  });
};

export default GenFeed;
```

## æ„Ÿæƒ³

ä»¥ä¸Šã§ã€ã¯ã¦ãƒ–ã‚„ Qiitaã€Zenn ã‚ãŸã‚Šã«åŠ£ã‚‰ã¬æ›¸ãå¿ƒåœ°ã«ãªã£ãŸã€‚

~~è‚å¿ƒã®è¨˜äº‹ã¯å…¨ç„¶å¢—ãˆãªã„ã‘ã©~~

:sob:

## TODO

- [ ] Twitter ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®é™çš„åŸ‹ã‚è¾¼ã¿
